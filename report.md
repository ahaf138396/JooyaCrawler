# گزارش تغییرات اتصال خزنده به سرویس Radar

## نمای کلی
این به‌روزرسانی‌ها برای هماهنگی خزنده با صف «frontier» سرویس Radar انجام شد و مسیرهای اتصال پایگاه‌داده بین Radar و خزنده یکپارچه شدند. همچنین حلقهٔ اصلی اجرا، مدیریت کارگرها و ذخیره‌سازی خروجی‌ها مطابق نیازهای جدید بازطراحی شد.

## جزئیات تغییرات کلیدی
### 1) اتصال و هماهنگی با صف Radar
- کلاس جدید **`RadarQueueManager`** برای کار با جدول `urls_frontier` اضافه شد که عملیات اتصال، شمارش وظایف آماده، دریافت وظیفه با قفل غیرمسدودکننده، ثبت موفقیت/شکست و صف‌کردن لینک‌های کشف‌شده را مدیریت می‌کند. وضعیت‌ها مطابق قرارداد Radar (`SCHEDULED`، `IN_PROGRESS`، `DONE`، `FAILED`) نگهداری می‌شوند و توابع به‌صورت async با `asyncpg` پیاده‌سازی شده‌اند تا به‌روز‌رسانی‌های اتمیک روی صف انجام شود.
- کارگرها از این مدیر صف استفاده می‌کنند تا لینک‌های جدید را با اطلاعات منبع، عمق، و اولویت به صف Radar اضافه کنند و پس از پردازش هر صفحه وضعیت را به `DONE` یا `FAILED` به‌روزرسانی کنند.

### 2) یکپارچه‌سازی تنظیمات پایگاه‌داده
- توابع کمکی جدید (`to_postgres_dsn` و `to_asyncpg_dsn`) برای نرمال‌سازی DSN معرفی شد تا URLهای مبتنی بر درایور (مثل `postgresql+psycopg2://` یا `asyncpg://`) با نیاز هر دو بخش Radar و خزنده سازگار باشند.
- مقداردهی اولیهٔ PostgreSQL اکنون علاوه بر متغیرهای قدیمی `POSTGRES_*` از `DATABASE_URL` (که توسط Radar استفاده می‌شود) پشتیبانی می‌کند و DSN نهایی را برای Tortoise ORM با طرح `asyncpg://` آماده می‌کند.

### 3) بازطراحی ورود، نظارت و اجرا
- ورودی برنامهٔ اصلی به جای زمان‌بندی اولیهٔ لینک‌ها، مستقیماً به صف Radar متصل می‌شود، ارتباط PostgreSQL و Mongo را برقرار می‌کند، و یک مجموعهٔ کارگر (قابل تنظیم با `WORKERS`) را راه‌اندازی می‌نماید.
- نظارت بر اندازهٔ صف Frontier در پس‌زمینه اجرا می‌شود و متریک‌ها روی سرور Prometheus در پورت ۸۰۰۰ ثبت می‌شوند.

### 4) بهبود جریان پردازش کارگر
- هر کارگر پیش از درخواست HTTP، سیاست فاصلهٔ خزیدن دامنه را از مدل `DomainCrawlPolicy` اعمال می‌کند.
- پاسخ‌ها با هدرهای مناسب ارسال می‌شوند، زمان پاسخ در متریک‌ها ثبت می‌شود و خطاهای HTTP به‌صورت مستند در `CrawlErrorLog` ذخیره می‌گردند.
- محتوای دریافت‌شده در Mongo نگهداری می‌شود؛ متن، عنوان و هش محتوا برای تشخیص تغییرات به‌روزرسانی می‌شوند و متادیتا (طول HTML/متن، تعداد لینک، هش) مدیریت می‌شود.
- لینک‌های استخراج‌شده (با سقف تعداد و حذف تکراری) هم به جدول `OutboundLink` افزوده می‌شوند و هم با حفظ منبع، عمق و اولویت به صف Radar برمی‌گردند تا گردش خزیدن ادامه یابد.

## نتیجه
با این تغییرات، خزنده به طور کامل با صف و قراردادهای Radar همگام شده و می‌تواند لینک‌ها را از جدول Frontier بخواند، پردازش کند و با ثبت متریک‌ها و خطاها نتیجه را در پایگاه‌داده و صف بازتاب دهد.
